<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    
    <title>Konstruktion.cdy</title>
    <style type="text/css">
        * {
            margin: 0px;
            padding: 0px;
        }

    </style>
    <script type="text/javascript" src="../../build/js/Cindy.js"></script>


               
    <script id="csinit" type="text/x-cindyscript">

        //======CODE FOR BUTTONS==========
        btns=[];
        btns=btns++[["move",(0,0),1,(0,0)]];
        btns=btns++[["singlepoint",(1,0),0,(0,0)]];
        btns=btns++[["singleline",(2,0),0,(0,0)]];
        sel=1;
        drawbutton(i):=(
            b=btns_i;
            p=b_2*2.3+(-13.5,17);
            btns_i_4=p;
            selected=(i==sel);
            if(selected,
              fillpoly([p+(-1,-.75),p+(-1,.75),p+(1,.75),p+(1,-.75)],color->(1,1,1)*.8);
              drawimage(p+(-1,-.75),p+(1,-.75),b_1);
              drawpoly([p+(-1,-.75),p+(-1,.75),p+(1,.75),p+(1,-.75)],color->(1,1,1)*0,size->2);

              ,
              fillpoly([p+(-1,-.75),p+(-1,.75),p+(1,.75),p+(1,-.75)],color->(1,1,1)*.6);
              drawimage(p+(-1,-.75),p+(1,-.75),b_1);
              drawpoly([p+(-1,-.75),p+(-1,.75),p+(1,.75),p+(1,-.75)],color->(1,1,1)*3,size->1);

            );
        );
        ////////

    ptcnt=0;
    lncnt=0;
    cncnt=0;

    inaction=false;
    selpts=[];
    sellns=[];
    selcns=[];
    tmppts=[];
    tmplns=[];
    tmpcns=[];

    nextpointlabel():=(ptcnt=ptcnt+1;"PT"+ptcnt);
    nextlinelabel():=(lncnt=lncnt+1;"LN"+lncnt);
    nextconiclabel():=(cncnt=cncnt+1;"CO"+cncnt);


    ishotp(pos,p):=|pos,p|<.5;

    ishotl(pos,l):=(
       regional(p);
       p=meet(l,perp(l,pos));
       |p.xy,pos|<.4;
    );
    
    ishotc(p,c):=(
       regional(mat,p1,p2,p3,p4,s1,s2,s3,s4);
       mat=c.matrix;
       p1=(p+(.4,0)).homog;
       p2=(p-(.4,0)).homog;
       p3=(p+(0,.4)).homog;
       p4=(p-(0,.4)).homog;
       s1=if(p1*mat*p1>0,1,-1);
       s2=if(p2*mat*p2>0,1,-1);
       s3=if(p3*mat*p3>0,1,-1);
       s4=if(p4*mat*p4>0,1,-1);

       set([s1,s2,s3,s4])==[-1,1];
    );
 
    
    elementsAtPos(pos):=(
      regional(spts,slns,scns);
      nearpts=select(pts,ishotp(pos,#));
      nearlns=select(lns,ishotl(pos,#));
      nearcns=select(cns,ishotc(pos,#));

      spts=nearpts;
      slns=[];
      scns=[];

      slns=if(spts==[],nearlns,[]);
      scns=if(spts==[],nearcns,[]);
      (spts,slns,scns);

    );

    resetsels():=(
      selpts=[];
      sellns=[];
      selcns=[];
    );

    //======GENERIC TRAP FOR  MOUSE EVENTS==========

    dodown():=( 
           pos=mouse().xy;
           if(pos.y<16, 
              inaction=true;
              parse(btns_sel_1+"Down(pos)");

           );
    );

    dodrag():=(
     if(inaction,
        pos=mouse().xy;
        parse(btns_sel_1+"Drag(pos)");
       );
    );

    doup():=(
           if(inaction,
             pos=mouse().xy;
             parse(btns_sel_1+"Up(pos)");

           );
           apply(allelements(),#.pinned=true);

    );

adjoint(m):=(
    (
      det(((m_2_2,m_2_3),(m_3_2,m_3_3))),
     -det(((m_2_1,m_2_3),(m_3_1,m_3_3))),
      det(((m_2_1,m_2_2),(m_3_1,m_3_2)))
    ),
    (
     -det(((m_1_2,m_1_3),(m_3_2,m_3_3))),
      det(((m_1_1,m_1_3),(m_3_1,m_3_3))),
     -det(((m_1_1,m_1_2),(m_3_1,m_3_2)))
    ),
    (
      det(((m_1_2,m_1_3),(m_2_2,m_2_3))),
     -det(((m_1_1,m_1_3),(m_2_1,m_2_3))),
      det(((m_1_1,m_1_2),(m_2_1,m_2_2)))
    )
);
crossop(l):=((0,l_3,-l_2),
             (-l_3,0,l_1),
             (l_2,-l_1,0));

intersectcc(c1,c2):=(
    cc=c1++c2;
    d3=det(cc_[1,2,3]);
    d2=det(cc_[1,2,6])+det(cc_[1,5,3])+det(cc_[4,2,3]);
    d1=det(cc_[4,5,3])+det(cc_[4,2,6])+det(cc_[1,5,6]);
    d0=det(cc_[4,5,6]);
    //TODO Degenerierte Fälle abfangen
    sols=roots([d0,d1,d2,d3]);
    sol1=sols_1;
    sol2=sols_2;
    deg1=c1*sol1+c2;
    deg2=c1*sol2+c2;

    ad1=adjoint(deg1);
    ad2=adjoint(deg2);
    p1=ad1_1/sqrt(-ad1_1_1);
    p2=ad2_1/sqrt(-ad2_1_1);

    mm1=crossop(p1);
    mm2=crossop(p2);
    sp1=mm1+deg1;
    sp2=mm2+deg2;

    l1=sp1_1;
    l2=transpose(sp1)_1;
    l3=sp2_1;
    l4=transpose(sp2)_1;

    [meet(l1,l3),meet(l2,l3),meet(l1,l4),meet(l2,l4)];
);

intersectcl(c,l):=(

    l1 = crossop(l);
    l2=transpose(l1);
    s=l2*c*l1;
    maxidx=sort(1..3,-|l_#|)_1;
    idx=(1..3)--[maxidx];
    a11 = s_(idx_1)_(idx_1);
    a12 = s_(idx_1)_(idx_2);
    a21 = s_(idx_2)_(idx_1);
    a22 = s_(idx_2)_(idx_2);
    b = l_maxidx;
    alp=sqrt(-det(((a11,a12),(a21,a22))))/b;
    erg=s+alp*l1;
    //TODO select col row
    erg1=point(erg_1);
    erg2=point(transpose(erg)_1);
    [erg1.xy, erg2.xy];
);

closest(list,pt):=(
   sort(list,|#.xy,pt.xy|)_1;
);

//======THE MODI ==========

toggleset(a,b):=(a--b)++(b--a);

//=======  MOVE  ==============
    moveDown(pos):=(
        apply(allelements(),#.pinned=false);    
        movedown=true;
        perhapsclick=true;
        movedownpos=mouse().xy;   
    );

    moveUp(pos):=(
       if(|movedownpos,mouse().xy|>.1,perhapsclick=false);
       if(perhapsclick,
            (spts,slns,scns)=elementsAtPos(pos);
            if((spts,slns,scns)==([],[],[]),
              (selpts,sellns,selcns)=([],[],[]);
            ,
              selpts=toggleset(selpts,spts);
              sellns=toggleset(sellns,slns);
              selcns=toggleset(selcns,scns);
            );

       );
    );

    moveDrag(pos):=(
      if(|movedownpos,mouse().xy|>.1,perhapsclick=false);

    );
//==============================


createSinglePoint(pos):=(
      regional(pt,prepare);
         (selpts,sellns,selcns)=elementsAtPos(pos);
         pt=pos;
         prepare="Free";
         params=[];
         if(length(selpts)==1,
            pt=(selpts_1).xy;
            prepare="Old";
            params=[selpts_1]
         );
         if(length(sellns)==1 & length(selcns)==0 ,
           pt=meet(sellns_1,perp(sellns_1,pos)).xy;
           prepare="PointOnLine";
           params=[sellns_1];
         );
         if(length(sellns)==2 & length(selcns)==0 ,
            pt=meet(sellns_1,sellns_2);
            prepare="Meet";
            params=[sellns_1,sellns_2];

         );
         if(length(sellns)==1 & length(selcns)==1 ,
           pt=closest(intersectcl((selcns_1).matrix,(sellns_1).homog),pos);
           prepare="IntersectLC";
           params=[sellns_1,selcns_1];

         );
         if(length(sellns)==0 & length(selcns)==2 ,
           pt=closest(intersectcc((selcns_1).matrix,(selcns_2).matrix),pos);
           prepare="IntersectionConicConic";
           params=[selcns_1,selcns_2];
         );
         [pt,prepare,params]; 

);

finalizetmps():=(
   newpts=[];
   apply(tmppts,tmp,

      if(tmp_4=="final",
         type="plain";
         if(tmp_2=="IntersectLC",type="Sel2");
         if(tmp_2=="IntersectionConicConic",type="Sel4");
         if(tmp_2=="Old",type="Old");

         if(type=="plain";,
            label=nextpointlabel();
            create([label],tmp_2,tmp_3++[(tmp_1)]);
            selpts=[element(label)];
            newpts=newpts++[element(label)];
         );

         if(type=="Sel2";,
            label1=nextpointlabel();
            label2=nextpointlabel();
            create([label1,label2],tmp_2,tmp_3++[(tmp_1)]);
            selpts=[element(label1),element(label2)];
         );

         if(type=="Sel4";,
            label1=nextpointlabel();
            label2=nextpointlabel();
            label3=nextpointlabel();
            label4=nextpointlabel();
            create([label1,label2,label3,label4],tmp_2,tmp_3++[(tmp_1)]);
            selpts=[element(label1),element(label2),element(label3),element(label4)];
   
         );

         if(type=="Old",
            selpts=[tmp_3_1];
            newpts=newpts++[tmp_3_1];
         );

      );

   );

   apply(tmplns,tmp,
         if(tmp_2=="Join";,
            label=nextlinelabel();
            print(newpts);
            el=create([label],tmp_2,newpts);
            sellns=[element(label)];
         );

   );


);
//=========ADD POINT============
    singlepointDown(pos):=(
         (pt,prepare,params)=createSinglePoint(pos);
         tmppts=[[pt,prepare,params,"final"]];
    );


    singlepointDrag(pos):=(
        
         (pt,prepare,params)=createSinglePoint(pos);
         tmppts=[[pt,prepare,params,"final"]];

    );


    singlepointUp(pos):=(
       resetsels();
       finalizetmps();
       tmppts=[];
    );

//==============================


//==============================
    singlelineDown(pos):=(
         (pt,prepare,params)=createSinglePoint(pos);
         first=[pt,prepare,params,"final"];
         tmppts=[first];
    );

    singlelineUp(pos):=(
       resetsels();
       finalizetmps();
       tmppts=[];
       tmplns=[];
    );

    singlelineDrag(pos):=(
        (pt,prepare,params)=createSinglePoint(pos);
         second=[pt,prepare,params,"final"];
         line=meet(first_1,second_1);
         tmppts=[first,second];
         tmplns=[[line,"Join",[first,second],"final"]];

    );
//==============================




    </script>
    

    <script id="csmousedown" type="text/x-cindyscript">
        pos=mouse().xy;
        apply(1..length(btns),i,
          if(|pos,btns_i_4|<1,sel=i);
        );

        dodown();
    </script>

    
    <script id="csmousedrag" type="text/x-cindyscript">
        dodrag();
    </script>

    <script id="csmouseup" type="text/x-cindyscript">

        doup();
    </script>






    <script id="csdraw" type="text/x-cindyscript">
        apply(1..length(btns),drawbutton(#));

        pts=allpoints();
        lns=alllines();
        cns=allconics();
        circs=allcircles();
        apply(selpts,draw(#,size->#.size+4,color->(1,1,1),border->false));
        apply(sellns,draw(#.homog,size->#.size+4,color->(1,1,1),border->false));
        apply(selcns,drawconic(#.matrix,size->#.size+4,color->(1,1,1),border->false));
        apply(tmppts,
          draw(#_1,size->5,color->(1,0,0));
          drawtext(#_1+(.2,.2),apply(#_1,q,format(q,2)),size->13,color->(1,1,1)*.4);
        );
        apply(tmplns,
          draw(line(#_1),size->2,color->(0,0,1));
        );

    </script>
    



    <script type="text/javascript">

var cdy = CindyJS({
  scripts: "cs*",
  defaultAppearance: {
    dimDependent: 0.7,
    fontFamily: "sans-serif",
    lineSize: 1,
    pointSize: 5.0,
    textsize: 12.0
  },
  angleUnit: "°",
  geometry: [
    {name: "A", type: "Free", pos: [4.0, -2.6440677966101696, -1.6949152542372883], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "B", type: "Free", pos: [-2.4484848484848487, -4.0, -0.6060606060606061], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "a", type: "Join", color: [0.0, 0.0, 1.0], args: ["A", "B"], labeled: true},
    {name: "C", type: "Free", pos: [-1.4585635359116023, -4.0, -0.5524861878453039], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "D", type: "Free", pos: [4.0, -0.6451612903225806, 3.225806451612903], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "b", type: "Join", color: [0.0, 0.0, 1.0], args: ["C", "D"], labeled: true},
    {name: "E", type: "Free", pos: [-3.3499999999999996, -4.0, -1.2499999999999998], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "C0", type: "CircleByRadius", pos: {xx: -0.0851034858387799, yy: -0.0851034858387799, zz: 0.9999999999999999, xy: 0.0, xz: 0.4561546840958603, yz: -0.5446623093681914}, color: [0.0, 0.0, 1.0], radius: 5.40118505515225, args: ["E"], printname: "$C_{0}$"},
    {name: "F", type: "PointOnCircle", pos: [4.0, {r: 1.5839261089361172, i: -1.401228376110472E-16}, {r: 0.49497690904253633, i: 1.1532127570557923E-32}], color: [1.0, 0.0, 0.0], args: ["C0"], labeled: true},
    {name: "G", type: "Free", pos: [4.0, -2.528, -0.8], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "H", type: "Free", pos: [0.5066666666666667, -4.0, -0.6666666666666666], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "K", type: "Free", pos: [4.0, 3.609756097560976, 0.6097560975609757], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "L", type: "Free", pos: [4.0, -1.2413793103448276, 0.8620689655172413], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "M", type: "Free", pos: [4.0, 0.8231511254019294, 0.3215434083601286], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "C1", type: "ConicBy5", color: [0.0, 0.0, 1.0], args: ["M", "H", "K", "L", "G"], printname: "$C_{1}$"},
    {name: "N", type: "Free", pos: [-2.2784810126582276, -4.0, -0.3164556962025316], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "O", type: "Free", pos: [4.0, 1.3617021276595744, 0.42553191489361697], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "P", type: "Free", pos: [4.0, 1.812332439678284, 0.2680965147453083], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "Poly0", type: "Poly", color: [0.0, 0.0, 0.0], fillcolor: [1.0, 0.784, 0.0], fillalpha: 1.0, args: ["N", "O", "P"]}
  ],
  ports: [{
    id: "CSCanvas",
    width: 852,
    height: 560,
    transform: [{visibleRect: [-15, 18, 20, -5]}],
    background: "rgb(168,176,192)"
  }],
      images:{
        "move":"images/move.png",
        "singlepoint":"images/single-add.png",
        "singleline":"images/multi-add-line.png"
    },
  csconsole: false,
  cinderella: {build: 1901, version: [2, 9, 1901]}
});
    </script>
</head>
<body>
    <div id="CSCanvas"></div>
</body>
</html>
